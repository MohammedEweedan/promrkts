//@version=5
indicator("promrkts Swing Pro", overlay=true, max_lines_count=500, max_labels_count=500, max_boxes_count=500)

// ─── SETTINGS ───────────────────────────────────────────────
grp1 = "Core"
pivotLen    = input.int(10,  "Pivot Lookback",     minval=3,  maxval=50,  group=grp1)
atrLen      = input.int(14,  "ATR Period",         minval=5,  maxval=50,  group=grp1)
atrSlMult   = input.float(1.5, "SL × ATR",        minval=0.5,maxval=5.0, step=0.1, group=grp1)
rrRatio     = input.float(2.0, "Min Reward:Risk",  minval=1.0,maxval=5.0, step=0.5, group=grp1)

grp2 = "Filters"
rsiLen      = input.int(14,  "RSI Period",         minval=5,  maxval=30,  group=grp2)
rsiOB       = input.int(70,  "RSI Overbought",     minval=60, maxval=90,  group=grp2)
rsiOS       = input.int(30,  "RSI Oversold",       minval=10, maxval=40,  group=grp2)
stochLen    = input.int(14,  "Stoch RSI Period",   minval=5,  maxval=30,  group=grp2)
stochSmooth = input.int(3,   "Stoch Smooth",       minval=1,  maxval=10,  group=grp2)
volMult     = input.float(1.0,"Volume ≥ Avg ×",    minval=0.5,maxval=3.0, step=0.1, group=grp2)

grp3 = "Sessions"
showSessions = input.bool(true, "Show Session Boxes",  group=grp3)
showSessHL   = input.bool(true, "Session High/Low",    group=grp3)
showNews     = input.bool(true, "Highlight News Candles", group=grp3)

grp4 = "Display"
showFib     = input.bool(true, "Fibonacci Levels",  group=grp4)
showSR      = input.bool(true, "S/R Zones",         group=grp4)
showEma     = input.bool(true, "Trend Ribbon",      group=grp4)

// ─── CALCULATIONS ───────────────────────────────────────────
atr         = ta.atr(atrLen)
rsi         = ta.rsi(close, rsiLen)
stochRsi    = ta.stoch(rsi, rsi, rsi, stochLen)
stochK      = ta.sma(stochRsi, stochSmooth)
stochD      = ta.sma(stochK, stochSmooth)
avgVol      = ta.sma(volume, 20)
volOk       = volume >= avgVol * volMult

ema50       = ta.ema(close, 50)
ema200      = ta.ema(close, 200)
trendUp     = ema50 > ema200
trendDn     = ema50 < ema200

// ─── SESSION DETECTION (UTC hours) ──────────────────────────
// Tokyo: 00:00–09:00 UTC | London: 07:00–16:00 UTC | New York: 12:00–21:00 UTC
tokyoOpen   = hour == 0  and minute == 0
tokyoClose  = hour == 9  and minute == 0
londonOpen  = hour == 7  and minute == 0
londonClose = hour == 16 and minute == 0
nyOpen      = hour == 12 and minute == 0
nyClose     = hour == 21 and minute == 0

inTokyo     = hour >= 0  and hour < 9
inLondon    = hour >= 7  and hour < 16
inNY        = hour >= 12 and hour < 21

// Track session OHLC
var float tokyoH = na, var float tokyoL = na, var float tokyoO = na
var float londonH = na, var float londonL = na, var float londonO = na
var float nyH = na, var float nyL = na, var float nyO = na

if tokyoOpen
    tokyoO := open, tokyoH := high, tokyoL := low
if inTokyo
    tokyoH := math.max(nz(tokyoH, high), high)
    tokyoL := math.min(nz(tokyoL, low), low)

if londonOpen
    londonO := open, londonH := high, londonL := low
if inLondon
    londonH := math.max(nz(londonH, high), high)
    londonL := math.min(nz(londonL, low), low)

if nyOpen
    nyO := open, nyH := high, nyL := low
if inNY
    nyH := math.max(nz(nyH, high), high)
    nyL := math.min(nz(nyL, low), low)

// Draw session open labels
if showSessions and tokyoOpen
    label.new(bar_index, high, "TKY Open", style=label.style_label_down, color=color.new(color.red, 70), textcolor=color.white, size=size.tiny)
if showSessions and londonOpen
    label.new(bar_index, high, "LDN Open", style=label.style_label_down, color=color.new(color.blue, 70), textcolor=color.white, size=size.tiny)
if showSessions and nyOpen
    label.new(bar_index, high, "NY Open", style=label.style_label_down, color=color.new(color.green, 70), textcolor=color.white, size=size.tiny)

// Draw session high/low on close
if showSessHL and tokyoClose and not na(tokyoH)
    line.new(bar_index - 1, tokyoH, bar_index + 5, tokyoH, color=color.new(color.red, 60), width=1, style=line.style_dotted)
    line.new(bar_index - 1, tokyoL, bar_index + 5, tokyoL, color=color.new(color.red, 60), width=1, style=line.style_dotted)
if showSessHL and londonClose and not na(londonH)
    line.new(bar_index - 1, londonH, bar_index + 5, londonH, color=color.new(color.blue, 60), width=1, style=line.style_dotted)
    line.new(bar_index - 1, londonL, bar_index + 5, londonL, color=color.new(color.blue, 60), width=1, style=line.style_dotted)
if showSessHL and nyClose and not na(nyH)
    line.new(bar_index - 1, nyH, bar_index + 5, nyH, color=color.new(color.green, 60), width=1, style=line.style_dotted)
    line.new(bar_index - 1, nyL, bar_index + 5, nyL, color=color.new(color.green, 60), width=1, style=line.style_dotted)

// Session background shading
bgcolor(showSessions and inTokyo  and not inLondon and not inNY ? color.new(color.red, 95)   : na, title="Tokyo BG")
bgcolor(showSessions and inLondon and not inNY                  ? color.new(color.blue, 95)  : na, title="London BG")
bgcolor(showSessions and inNY                                   ? color.new(color.green, 95) : na, title="NY BG")

// ─── NEWS CANDLE DETECTION ──────────────────────────────────
// News candles = abnormal volume spike + large body relative to ATR
volSpike    = volume > avgVol * 2.5
bigBody     = math.abs(close - open) > atr * 1.2
newsCandle  = volSpike and bigBody

// Common news times (UTC): NFP/CPI typically 13:30, FOMC 19:00, ECB 12:45
isCommonNewsTime = (hour == 13 and minute >= 25 and minute <= 35) or (hour == 19 and minute == 0) or (hour == 12 and minute >= 40 and minute <= 50) or (hour == 15 and minute == 0)
newsHighlight = showNews and (newsCandle or (isCommonNewsTime and volSpike))

barcolor(newsHighlight ? color.new(color.yellow, 0) : na, title="News Candle")
plotshape(newsHighlight, title="News", location=location.abovebar, style=shape.flag, color=color.yellow, size=size.tiny)

// ─── PIVOT DETECTION (confirmed) ────────────────────────────
pivHi       = ta.pivothigh(high, pivotLen, pivotLen)
pivLo       = ta.pivotlow(low,  pivotLen, pivotLen)

var float lastPH = na
var float lastPL = na
var int   lastPHBar = na
var int   lastPLBar = na

if not na(pivHi)
    lastPH    := pivHi
    lastPHBar := bar_index - pivotLen
if not na(pivLo)
    lastPL    := pivLo
    lastPLBar := bar_index - pivotLen

// ─── FIBONACCI ──────────────────────────────────────────────
validFib = not na(lastPH) and not na(lastPL) and lastPH > lastPL
fibRange = validFib ? lastPH - lastPL : 0.0

fib0   = lastPL
fib236 = validFib ? lastPL + fibRange * 0.236 : na
fib314 = validFib ? lastPL + fibRange * 0.314 : na
fib5   = validFib ? lastPL + fibRange * 0.5   : na
fib618 = validFib ? lastPL + fibRange * 0.618 : na
fib88  = validFib ? lastPL + fibRange * 0.88  : na
fib1   = lastPH

var line l0=na, var line l236=na, var line l314=na, var line l5=na
var line l618=na, var line l88=na, var line l1=na

if showFib and validFib
    startBar = math.max(nz(lastPHBar), nz(lastPLBar))
    endBar   = bar_index + 20

    line.delete(l0),   l0   := line.new(startBar, fib0,   endBar, fib0,   color=color.new(color.gray, 40),   width=1)
    line.delete(l236), l236 := line.new(startBar, fib236, endBar, fib236, color=color.new(color.gray, 60),   width=1, style=line.style_dotted)
    line.delete(l314), l314 := line.new(startBar, fib314, endBar, fib314, color=color.new(color.green, 30),  width=2, style=line.style_dashed)
    line.delete(l5),   l5   := line.new(startBar, fib5,   endBar, fib5,   color=color.new(color.yellow, 40), width=1, style=line.style_dotted)
    line.delete(l618), l618 := line.new(startBar, fib618, endBar, fib618, color=color.new(color.orange, 40), width=1, style=line.style_dotted)
    line.delete(l88),  l88  := line.new(startBar, fib88,  endBar, fib88,  color=color.new(color.red, 30),    width=2, style=line.style_dashed)
    line.delete(l1),   l1   := line.new(startBar, fib1,   endBar, fib1,   color=color.new(color.gray, 40),   width=1)

// ─── OVERBOUGHT / OVERSOLD CONDITIONS ──────────────────────
oversold   = rsi < rsiOS and stochK < 20 and ta.crossover(stochK, stochD)
overbought = rsi > rsiOB and stochK > 80 and ta.crossunder(stochK, stochD)

// ─── SIGNAL LOGIC ───────────────────────────────────────────
nearBuyZone  = validFib and math.abs(close - fib314) < atr
nearSellZone = validFib and math.abs(close - fib88)  < atr

buyCond  = nearBuyZone  and oversold  and volOk and trendUp
sellCond = nearSellZone and overbought and volOk and trendDn

var int lastBuyBar  = 0
var int lastSellBar = 0
cooldown = pivotLen * 2

buySignal  = buyCond  and (bar_index - lastBuyBar)  > cooldown
sellSignal = sellCond and (bar_index - lastSellBar) > cooldown

buySL  = buySignal  ? close - atr * atrSlMult : na
buyTP  = buySignal  ? close + atr * atrSlMult * rrRatio : na
sellSL = sellSignal ? close + atr * atrSlMult : na
sellTP = sellSignal ? close - atr * atrSlMult * rrRatio : na

if buySignal
    lastBuyBar := bar_index
    label.new(bar_index, low, "BUY\n" + str.tostring(close, format.mintick) +
         "\nSL " + str.tostring(buySL, format.mintick) +
         "\nTP " + str.tostring(buyTP, format.mintick),
         style=label.style_label_up, color=color.new(color.green, 0), textcolor=color.white, size=size.small)

if sellSignal
    lastSellBar := bar_index
    label.new(bar_index, high, "SELL\n" + str.tostring(close, format.mintick) +
         "\nSL " + str.tostring(sellSL, format.mintick) +
         "\nTP " + str.tostring(sellTP, format.mintick),
         style=label.style_label_down, color=color.new(color.red, 0), textcolor=color.white, size=size.small)

// ─── S/R ZONES ──────────────────────────────────────────────
if showSR and not na(pivHi)
    line.new(bar_index - pivotLen, pivHi, bar_index + 10, pivHi,
         color=color.new(color.red, 70), width=1, style=line.style_dotted)
if showSR and not na(pivLo)
    line.new(bar_index - pivotLen, pivLo, bar_index + 10, pivLo,
         color=color.new(color.green, 70), width=1, style=line.style_dotted)

// ─── TREND RIBBON ───────────────────────────────────────────
ema50Plot  = plot(showEma ? ema50  : na, "EMA 50",  color=color.new(color.blue, 60),   linewidth=1)
ema200Plot = plot(showEma ? ema200 : na, "EMA 200", color=color.new(color.orange, 60), linewidth=1)
fill(ema50Plot, ema200Plot, color=trendUp ? color.new(color.green, 92) : color.new(color.red, 92))

// ─── SIGNAL PLOTS ───────────────────────────────────────────
plotshape(buySignal,  title="Buy",  location=location.belowbar, color=color.green, style=shape.triangleup,   size=size.small)
plotshape(sellSignal, title="Sell", location=location.abovebar, color=color.red,   style=shape.triangledown, size=size.small)

// ─── ALERTS ─────────────────────────────────────────────────
alertcondition(buySignal,  "promrkts Swing Buy",  "promrkts Swing Pro: BUY at {{close}}")
alertcondition(sellSignal, "promrkts Swing Sell", "promrkts Swing Pro: SELL at {{close}}")
