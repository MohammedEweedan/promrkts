//@version=5
indicator("promrkts Day Pro", overlay=true, max_lines_count=500, max_labels_count=500, max_boxes_count=500)

// ─── SETTINGS ───────────────────────────────────────────────
grp1 = "Core"
pivotLen    = input.int(8,   "Pivot Lookback",     minval=3,  maxval=30,  group=grp1)
atrLen      = input.int(14,  "ATR Period",         minval=5,  maxval=30,  group=grp1)
atrSlMult   = input.float(1.2,"SL x ATR",         minval=0.5,maxval=4.0, step=0.1, group=grp1)
rrRatio     = input.float(2.0,"Min Reward:Risk",   minval=1.0,maxval=5.0, step=0.5, group=grp1)

grp2 = "Filters"
rsiLen      = input.int(14,  "RSI Period",         minval=5,  maxval=30,  group=grp2)
rsiOB       = input.int(70,  "RSI Overbought",     minval=60, maxval=90,  group=grp2)
rsiOS       = input.int(30,  "RSI Oversold",       minval=10, maxval=40,  group=grp2)
macdFast    = input.int(12,  "MACD Fast",          minval=5,  maxval=30,  group=grp2)
macdSlow    = input.int(26,  "MACD Slow",          minval=15, maxval=50,  group=grp2)
macdSig     = input.int(9,   "MACD Signal",        minval=3,  maxval=20,  group=grp2)
volMult     = input.float(1.0,"Volume >= Avg x",   minval=0.5,maxval=3.0, step=0.1, group=grp2)
useSessions = input.bool(true,"Session Filter",     group=grp2)

grp3 = "Sessions"
showSessions = input.bool(true, "Show Session Boxes",     group=grp3)
showSessHL   = input.bool(true, "Session High/Low",       group=grp3)
showNews     = input.bool(true, "Highlight News Candles",  group=grp3)

grp4 = "Display"
showFib     = input.bool(true, "Fibonacci Levels",  group=grp4)
showVwap    = input.bool(true, "VWAP",              group=grp4)
showEma     = input.bool(true, "EMA Stack",         group=grp4)
showSR      = input.bool(true, "S/R Pivots",        group=grp4)

// ─── CALCULATIONS ───────────────────────────────────────────
atr         = ta.atr(atrLen)
rsi         = ta.rsi(close, rsiLen)
[macdLine, signalLine, histLine] = ta.macd(close, macdFast, macdSlow, macdSig)
avgVol      = ta.sma(volume, 20)
volOk       = volume >= avgVol * volMult

ema20       = ta.ema(close, 20)
ema50       = ta.ema(close, 50)
ema200      = ta.ema(close, 200)

// EMA stack alignment (institutional trend filter)
bullStack   = ema20 > ema50 and ema50 > ema200
bearStack   = ema20 < ema50 and ema50 < ema200

vwapVal     = ta.vwap(close)

// Candle quality
bodyPct     = math.abs(close - open) / (high - low + syminfo.mintick)
strongCandle = bodyPct > 0.35

// ─── SESSION DETECTION (UTC) ────────────────────────────────
// Tokyo: 00:00-09:00 | London: 07:00-16:00 | New York: 12:00-21:00
tokyoOpen   = hour == 0  and minute == 0
tokyoClose  = hour == 9  and minute == 0
londonOpen  = hour == 7  and minute == 0
londonClose = hour == 16 and minute == 0
nyOpen      = hour == 12 and minute == 0
nyClose     = hour == 21 and minute == 0

inTokyo     = hour >= 0  and hour < 9
inLondon    = hour >= 7  and hour < 16
inNY        = hour >= 12 and hour < 21

// Session filter for signals
inSession   = useSessions ? (inLondon or inNY) : true

// Track session OHLC
var float tokyoH = na, var float tokyoL = na, var float tokyoO = na
var float londonH = na, var float londonL = na, var float londonO = na
var float nyH = na, var float nyL = na, var float nyO = na

if tokyoOpen
    tokyoO := open, tokyoH := high, tokyoL := low
if inTokyo
    tokyoH := math.max(nz(tokyoH, high), high)
    tokyoL := math.min(nz(tokyoL, low), low)

if londonOpen
    londonO := open, londonH := high, londonL := low
if inLondon
    londonH := math.max(nz(londonH, high), high)
    londonL := math.min(nz(londonL, low), low)

if nyOpen
    nyO := open, nyH := high, nyL := low
if inNY
    nyH := math.max(nz(nyH, high), high)
    nyL := math.min(nz(nyL, low), low)

// Draw session open labels
if showSessions and tokyoOpen
    label.new(bar_index, high, "TKY Open", style=label.style_label_down, color=color.new(color.red, 70), textcolor=color.white, size=size.tiny)
if showSessions and londonOpen
    label.new(bar_index, high, "LDN Open", style=label.style_label_down, color=color.new(color.blue, 70), textcolor=color.white, size=size.tiny)
if showSessions and nyOpen
    label.new(bar_index, high, "NY Open", style=label.style_label_down, color=color.new(color.green, 70), textcolor=color.white, size=size.tiny)

// Draw session close labels
if showSessions and tokyoClose
    label.new(bar_index, low, "TKY Close", style=label.style_label_up, color=color.new(color.red, 80), textcolor=color.white, size=size.tiny)
if showSessions and londonClose
    label.new(bar_index, low, "LDN Close", style=label.style_label_up, color=color.new(color.blue, 80), textcolor=color.white, size=size.tiny)
if showSessions and nyClose
    label.new(bar_index, low, "NY Close", style=label.style_label_up, color=color.new(color.green, 80), textcolor=color.white, size=size.tiny)

// Draw session high/low on close
if showSessHL and tokyoClose and not na(tokyoH)
    line.new(bar_index - 1, tokyoH, bar_index + 8, tokyoH, color=color.new(color.red, 50), width=1, style=line.style_dotted)
    line.new(bar_index - 1, tokyoL, bar_index + 8, tokyoL, color=color.new(color.red, 50), width=1, style=line.style_dotted)
if showSessHL and londonClose and not na(londonH)
    line.new(bar_index - 1, londonH, bar_index + 8, londonH, color=color.new(color.blue, 50), width=1, style=line.style_dotted)
    line.new(bar_index - 1, londonL, bar_index + 8, londonL, color=color.new(color.blue, 50), width=1, style=line.style_dotted)
if showSessHL and nyClose and not na(nyH)
    line.new(bar_index - 1, nyH, bar_index + 8, nyH, color=color.new(color.green, 50), width=1, style=line.style_dotted)
    line.new(bar_index - 1, nyL, bar_index + 8, nyL, color=color.new(color.green, 50), width=1, style=line.style_dotted)

// Session background shading
bgcolor(showSessions and inTokyo  and not inLondon and not inNY ? color.new(color.red, 96)   : na, title="Tokyo BG")
bgcolor(showSessions and inLondon and not inNY                  ? color.new(color.blue, 96)  : na, title="London BG")
bgcolor(showSessions and inNY                                   ? color.new(color.green, 96) : na, title="NY BG")

// ─── NEWS CANDLE DETECTION ──────────────────────────────────
volSpike    = volume > avgVol * 2.5
bigBody     = math.abs(close - open) > atr * 1.2
newsCandle  = volSpike and bigBody

// Common news times (UTC): NFP/CPI 13:30, FOMC 19:00, ECB 12:45, US Open 14:30
isCommonNewsTime = (hour == 13 and minute >= 25 and minute <= 35) or (hour == 19 and minute == 0) or (hour == 12 and minute >= 40 and minute <= 50) or (hour == 14 and minute >= 25 and minute <= 35)
newsHighlight = showNews and (newsCandle or (isCommonNewsTime and volSpike))

barcolor(newsHighlight ? color.new(color.yellow, 0) : na, title="News Candle")
plotshape(newsHighlight, title="News", location=location.abovebar, style=shape.flag, color=color.yellow, size=size.tiny)

// ─── PIVOT DETECTION ────────────────────────────────────────
pivHi       = ta.pivothigh(high, pivotLen, pivotLen)
pivLo       = ta.pivotlow(low,  pivotLen, pivotLen)

var float lastPH = na
var float lastPL = na
var int   lastPHBar = na
var int   lastPLBar = na

if not na(pivHi)
    lastPH    := pivHi
    lastPHBar := bar_index - pivotLen
if not na(pivLo)
    lastPL    := pivLo
    lastPLBar := bar_index - pivotLen

// ─── FIBONACCI ──────────────────────────────────────────────
validFib = not na(lastPH) and not na(lastPL) and lastPH > lastPL
fibRange = validFib ? lastPH - lastPL : 0.0

fib0   = lastPL
fib236 = validFib ? lastPL + fibRange * 0.236 : na
fib314 = validFib ? lastPL + fibRange * 0.314 : na
fib382 = validFib ? lastPL + fibRange * 0.382 : na
fib5   = validFib ? lastPL + fibRange * 0.5   : na
fib618 = validFib ? lastPL + fibRange * 0.618 : na
fib88  = validFib ? lastPL + fibRange * 0.88  : na
fib1   = lastPH

var line l0=na, var line l236=na, var line l314=na, var line l382=na
var line l5=na, var line l618=na, var line l88=na, var line l1=na

if showFib and validFib
    startBar = math.max(nz(lastPHBar), nz(lastPLBar))
    endBar   = bar_index + 15

    line.delete(l0),   l0   := line.new(startBar, fib0,   endBar, fib0,   color=color.new(color.gray, 40),   width=1)
    line.delete(l236), l236 := line.new(startBar, fib236, endBar, fib236, color=color.new(color.gray, 60),   width=1, style=line.style_dotted)
    line.delete(l314), l314 := line.new(startBar, fib314, endBar, fib314, color=color.new(color.teal, 20),   width=2, style=line.style_dashed)
    line.delete(l382), l382 := line.new(startBar, fib382, endBar, fib382, color=color.new(color.gray, 60),   width=1, style=line.style_dotted)
    line.delete(l5),   l5   := line.new(startBar, fib5,   endBar, fib5,   color=color.new(color.yellow, 40), width=1, style=line.style_dotted)
    line.delete(l618), l618 := line.new(startBar, fib618, endBar, fib618, color=color.new(color.orange, 40), width=1, style=line.style_dotted)
    line.delete(l88),  l88  := line.new(startBar, fib88,  endBar, fib88,  color=color.new(color.maroon, 20), width=2, style=line.style_dashed)
    line.delete(l1),   l1   := line.new(startBar, fib1,   endBar, fib1,   color=color.new(color.gray, 40),   width=1)

// ─── OVERBOUGHT / OVERSOLD + MACD ──────────────────────────
oversold   = rsi < rsiOS and macdLine < signalLine and macdLine < 0
overbought = rsi > rsiOB and macdLine > signalLine and macdLine > 0

// RSI reversal + MACD histogram flip
rsiTurnUp  = oversold[1]  and rsi > rsi[1] and histLine > histLine[1]
rsiTurnDn  = overbought[1] and rsi < rsi[1] and histLine < histLine[1]

// ─── SIGNAL LOGIC ───────────────────────────────────────────
nearBuyZone  = validFib and math.abs(close - fib314) < atr
nearSellZone = validFib and math.abs(close - fib88)  < atr

// VWAP confluence
vwapBuyOk   = close >= vwapVal or math.abs(close - vwapVal) < atr * 0.5
vwapSellOk  = close <= vwapVal or math.abs(close - vwapVal) < atr * 0.5

// BUY: near 0.314, RSI turning up + MACD confirm, EMA bullish stack, VWAP ok, volume, session, strong candle
buyCond  = nearBuyZone  and rsiTurnUp and volOk and bullStack and vwapBuyOk  and inSession and strongCandle
// SELL: near 0.88, RSI turning down + MACD confirm, EMA bearish stack, VWAP ok, volume, session, strong candle
sellCond = nearSellZone and rsiTurnDn and volOk and bearStack and vwapSellOk and inSession and strongCandle

var int lastBuyBar  = 0
var int lastSellBar = 0
cooldown = pivotLen * 2

buySignal  = buyCond  and (bar_index - lastBuyBar)  > cooldown
sellSignal = sellCond and (bar_index - lastSellBar) > cooldown

// Compute SL / dual TP
buySL   = buySignal  ? close - atr * atrSlMult : na
buyTP1  = buySignal  ? close + atr * atrSlMult * rrRatio : na
buyTP2  = buySignal  ? close + atr * atrSlMult * rrRatio * 1.5 : na
sellSL  = sellSignal ? close + atr * atrSlMult : na
sellTP1 = sellSignal ? close - atr * atrSlMult * rrRatio : na
sellTP2 = sellSignal ? close - atr * atrSlMult * rrRatio * 1.5 : na

if buySignal
    lastBuyBar := bar_index
    label.new(bar_index, low, "BUY\n" + str.tostring(close, format.mintick) +
         "\nSL " + str.tostring(buySL, format.mintick) +
         "\nTP1 " + str.tostring(buyTP1, format.mintick) +
         "\nTP2 " + str.tostring(buyTP2, format.mintick),
         style=label.style_label_up, color=color.new(color.teal, 0), textcolor=color.white, size=size.small)
    line.new(bar_index, buySL,  bar_index + 15, buySL,  color=color.red,   width=2, style=line.style_solid)
    line.new(bar_index, buyTP1, bar_index + 15, buyTP1, color=color.green,  width=1, style=line.style_dashed)
    line.new(bar_index, buyTP2, bar_index + 15, buyTP2, color=color.green,  width=2, style=line.style_dashed)

if sellSignal
    lastSellBar := bar_index
    label.new(bar_index, high, "SELL\n" + str.tostring(close, format.mintick) +
         "\nSL " + str.tostring(sellSL, format.mintick) +
         "\nTP1 " + str.tostring(sellTP1, format.mintick) +
         "\nTP2 " + str.tostring(sellTP2, format.mintick),
         style=label.style_label_down, color=color.new(color.maroon, 0), textcolor=color.white, size=size.small)
    line.new(bar_index, sellSL,  bar_index + 15, sellSL,  color=color.red,   width=2, style=line.style_solid)
    line.new(bar_index, sellTP1, bar_index + 15, sellTP1, color=color.green,  width=1, style=line.style_dashed)
    line.new(bar_index, sellTP2, bar_index + 15, sellTP2, color=color.green,  width=2, style=line.style_dashed)

// ─── S/R PIVOTS ─────────────────────────────────────────────
if showSR and not na(pivHi)
    line.new(bar_index - pivotLen, pivHi, bar_index + 10, pivHi,
         color=color.new(color.red, 70), width=1, style=line.style_dotted)
if showSR and not na(pivLo)
    line.new(bar_index - pivotLen, pivLo, bar_index + 10, pivLo,
         color=color.new(color.green, 70), width=1, style=line.style_dotted)

// ─── EMA STACK ──────────────────────────────────────────────
plot(showEma ? ema20  : na, "EMA 20",  color=color.new(color.yellow, 40), linewidth=1)
ema50Plot  = plot(showEma ? ema50  : na, "EMA 50",  color=color.new(color.blue, 50),   linewidth=1)
ema200Plot = plot(showEma ? ema200 : na, "EMA 200", color=color.new(color.orange, 50), linewidth=2)
fill(ema50Plot, ema200Plot, color=bullStack ? color.new(color.green, 93) : bearStack ? color.new(color.red, 93) : color.new(color.gray, 97))

// ─── VWAP ───────────────────────────────────────────────────
plot(showVwap ? vwapVal : na, "VWAP", color=color.new(color.purple, 30), linewidth=2, style=plot.style_circles)

// ─── SIGNAL PLOTS ───────────────────────────────────────────
plotshape(buySignal,  title="Buy",  location=location.belowbar, color=color.teal,   style=shape.triangleup,   size=size.small)
plotshape(sellSignal, title="Sell", location=location.abovebar, color=color.maroon, style=shape.triangledown, size=size.small)

// ─── ALERTS ─────────────────────────────────────────────────
alertcondition(buySignal,  "Day Buy",  "promrkts Day Pro: BUY at {{close}}")
alertcondition(sellSignal, "Day Sell", "promrkts Day Pro: SELL at {{close}}")
